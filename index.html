<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aura Evolution</title>
    <!-- Подключаем библиотеки -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <!-- СТИЛИ (CSS) ПРЯМО ЗДЕСЬ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap');

        body {
            margin: 0;
            padding: 0;
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); /* КОСМОС */
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: white;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            justify-content: space-between;
            position: relative;
            z-index: 1;
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-box h1 {
            margin: 0;
            font-size: 2.5rem;
            text-shadow: 0 0 15px rgba(127, 90, 240, 0.5);
        }

        .label { font-size: 0.8rem; color: #a0a0a0; letter-spacing: 2px; text-transform: uppercase; }

        .buttons { display: flex; gap: 10px; }

        .icon-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            width: 44px; 
            height: 44px;
            color: white;
            display: flex; 
            align-items: center; 
            justify-content: center;
            cursor: pointer;
            z-index: 20; /* Чтобы точно нажимались */
        }

        /* MAIN */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #rank-name {
            font-size: 1.8rem;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 800;
            min-height: 40px;
        }

        .card-wrapper {
            width: 280px;
            height: 280px;
            position: relative;
        }

        .image-container {
            width: 100%; height: 100%;
            border-radius: 24px;
            overflow: hidden;
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }

        .image-container.clicked { transform: scale(0.95); }

        #rank-image {
            width: 100%; height: 100%; object-fit: cover;
            display: none; /* Скрыто пока не загрузится */
        }
        
        /* Текст если картинки нет */
        .no-image-text {
            position: absolute;
            text-align: center;
            padding: 10px;
            color: #aaa;
            font-size: 0.9rem;
        }

        /* Кнопка клика на весь экран */
        #click-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
        }

        /* FOOTER */
        .footer { width: 100%; text-align: center; padding-bottom: 20px; }
        
        .progress-wrapper {
            background: rgba(255,255,255,0.1);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%; width: 50%;
            background: #7f5af0;
            transition: width 0.3s;
        }

        /* MODALS */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 999; /* Поверх всего */
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.visible {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: #16161a;
            width: 90%;
            height: 80%;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border: 1px solid #7f5af0;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 10px; right: 10px;
            background: #ff4d4d;
            border: none;
            color: white;
            font-weight: bold;
            width: 40px; height: 40px;
            border-radius: 50%;
            font-size: 24px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            z-index: 1000;
        }

        /* LISTS */
        .list-container {
            overflow-y: auto;
            flex-grow: 1;
            margin-top: 40px;
        }

        .list-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            margin-bottom: 8px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
        }

        /* COLLECTION GRID */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            overflow-y: auto;
            margin-top: 40px;
        }
        
        .grid-item {
            background: rgba(255,255,255,0.05);
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .grid-item img { width: 100%; height: 100%; object-fit: cover; }
        .grid-item.locked img { opacity: 0.3; filter: grayscale(1); }
        .grid-item.locked::after { content: '?'; font-size: 2rem; position: absolute; }
        .grid-item span { position: absolute; bottom: 0; font-size: 0.6rem; background: rgba(0,0,0,0.8); width: 100%; text-align: center; }

        /* FLOATING TEXT */
        .float-text {
            position: absolute;
            font-weight: bold;
            font-size: 1.5rem;
            animation: floatUp 1s forwards;
            pointer-events: none;
            z-index: 100;
        }
        @keyframes floatUp { to { transform: translateY(-100px); opacity: 0; } }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <div class="score-box">
                <div class="label">AURA POINTS</div>
                <h1 id="score">0</h1>
            </div>
            <div class="buttons">
                <!-- Кнопки с явными onclick -->
                <div class="icon-btn" onclick="openModal('collection-modal')">
                    <span class="material-icons-round">auto_stories</span>
                </div>
                <div class="icon-btn" onclick="openModal('leaderboard-modal')">
                    <span class="material-icons-round">emoji_events</span>
                </div>
            </div>
        </div>

        <!-- MAIN -->
        <div class="main-content">
            <h2 id="rank-name">Загрузка...</h2>
            <div class="card-wrapper">
                <div class="image-container" id="img-cont">
                    <!-- Заглушка если нет картинки -->
                    <div class="no-image-text">(Картинка ранга)</div>
                    <img id="rank-image" src="" onerror="this.style.display='none';">
                </div>
            </div>
            <!-- Невидимый слой для кликов -->
            <div id="click-overlay"></div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <div class="progress-wrapper">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="label">ТАПАЙ ЧТОБЫ ИЗМЕНИТЬ СУДЬБУ</div>
        </div>
    </div>

    <!-- МОДАЛКА РЕЙТИНГА -->
    <div id="leaderboard-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('leaderboard-modal')">×</button>
            <h2 style="margin-top:0;">Лидеры</h2>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button onclick="loadLeaderboard('top')" style="flex:1; padding:10px; background:#7f5af0; border:none; color:white; border-radius:8px;">TOP G</button>
                <button onclick="loadLeaderboard('bottom')" style="flex:1; padding:10px; background:#ef4565; border:none; color:white; border-radius:8px;">SAD</button>
            </div>
            <div id="lb-list" class="list-container">Загрузка...</div>
        </div>
    </div>

    <!-- МОДАЛКА КОЛЛЕКЦИИ -->
    <div id="collection-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('collection-modal')">×</button>
            <h2 style="margin-top:0;">Коллекция</h2>
            <div id="col-grid" class="grid-container"></div>
        </div>
    </div>

    <!-- СКРИПТ (ЛОГИКА) ПРЯМО ЗДЕСЬ -->
    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://vvumgyyafdwnhhothvqd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2dW1neXlhZmR3bmhob3RodnFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNTIzNjIsImV4cCI6MjA3OTkyODM2Mn0.dVU9j4FLhdk4a7RbyAMo2tfFDBJ8s2_GBXoDDTNj1xE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const tg = window.Telegram.WebApp;

        tg.expand();

        let user = { id: 0, username: 'Guest', score: 0 };
        const audioLevelUp = new Audio('assets/level_up.mp3'); 

        // --- РАНГИ ---
        const ranks = [
            { min: -100000000, name: "Космическая Пыль", img: "rank_1.jpg" },
            { min: -50000000, name: "Атом Кринжа", img: "rank_2.jpg" },
            { min: -25000000, name: "Салфетка", img: "rank_3.jpg" },
            { min: -10000000, name: "Плесневый Гриб", img: "rank_4.jpg" },
            { min: -5000000, name: "Ершик", img: "rank_5.jpg" },
            { min: -2500000, name: "Носок", img: "rank_6.jpg" },
            { min: -1000000, name: "Пельмень", img: "rank_7.jpg" },
            { min: -500000, name: "Комар", img: "rank_8.jpg" },
            { min: -250000, name: "Душнила", img: "rank_9.jpg" },
            { min: -100000, name: "Диванный Воин", img: "rank_10.jpg" },
            { min: -50000, name: "Карен", img: "rank_11.jpg" },
            { min: -10000, name: "Симп", img: "rank_12.jpg" },
            { min: -1000, name: "NPC", img: "rank_13.jpg" },
            { min: 5000, name: "Трогатель Травы", img: "rank_14.jpg" },
            { min: 20000, name: "Водохлёб", img: "rank_15.jpg" },
            { min: 50000, name: "Турникмен", img: "rank_16.jpg" },
            { min: 100000, name: "Офисный Выживший", img: "rank_17.jpg" },
            { min: 250000, name: "Мамкин Инвестор", img: "rank_18.jpg" },
            { min: 500000, name: "Темщик", img: "rank_19.jpg" },
            { min: 1000000, name: "Биткоин Барон", img: "rank_20.jpg" },
            { min: 2500000, name: "Мастер Мьюинга", img: "rank_21.jpg" },
            { min: 5000000, name: "Рицц-Лорд", img: "rank_22.jpg" },
            { min: 10000000, name: "Патрик", img: "rank_23.jpg" },
            { min: 25000000, name: "Гигачад", img: "rank_24.jpg" },
            { min: 50000000, name: "Нейро Бог", img: "rank_25.jpg" },
            { min: 100000000, name: "Путешественник", img: "rank_26.jpg" },
            { min: 250000000, name: "Император", img: "rank_27.jpg" },
            { min: 500000000, name: "Чистая Энергия", img: "rank_28.jpg" },
            { min: 1000000000, name: "DEV", img: "rank_29.jpg" },
            { min: 5000000000, name: "АБСОЛЮТ", img: "rank_30.jpg" }
        ];

        // --- ФУНКЦИИ ---

        function openModal(id) {
            document.getElementById(id).classList.add('visible');
            if(id === 'collection-modal') renderCollection();
            if(id === 'leaderboard-modal') loadLeaderboard('top');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('visible');
        }

        function getRank(score) {
            let r = ranks[12];
            for(let i=0; i<ranks.length; i++) {
                if(score >= ranks[i].min) r = ranks[i];
            }
            return r;
        }

        function updateUI() {
            document.getElementById('score').innerText = user.score.toLocaleString();
            const rank = getRank(user.score);
            const nameEl = document.getElementById('rank-name');
            const imgEl = document.getElementById('rank-image');
            
            if(nameEl.innerText !== rank.name) {
                nameEl.innerText = rank.name;
                imgEl.src = `assets/${rank.img}`;
                imgEl.style.display = 'block'; // Показываем картинку
                
                // Звук только тут
                if(Math.abs(user.score) > 1000) {
                   audioLevelUp.play().catch(()=>{}); 
                }
            }

            // Бар
            let percent = 50;
            const range = 500000;
            if (user.score !== 0) {
                let shift = (user.score / range) * 50;
                shift = Math.max(-50, Math.min(50, shift));
                percent = 50 + shift;
            }
            document.getElementById('progress-bar').style.width = percent + "%";
        }

        // --- КЛИКЕР ---
        document.getElementById('click-overlay').addEventListener('click', (e) => {
            // Анимация
            const cont = document.getElementById('img-cont');
            cont.classList.add('clicked');
            setTimeout(()=>cont.classList.remove('clicked'), 80);
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');

            // Математика
            let isCrit = Math.random() > 0.98;
            let isPlus = Math.random() > 0.45; // 55% шанс успеха
            if(isCrit) isPlus = true;

            let pts = Math.floor(Math.random() * 2000) + 100;
            if(isCrit) pts *= 10;
            
            let val = isPlus ? pts : -pts;
            user.score += val;

            // БЕЗ ЗВУКА НА КЛИК (как просил)
            
            // Эффект цифры
            const el = document.createElement('div');
            el.className = 'float-text';
            el.innerText = val > 0 ? `+${val.toLocaleString()}` : val.toLocaleString();
            el.style.color = val > 0 ? '#2cb67d' : '#ef4565';
            if(isCrit) { el.style.color = '#ffd700'; el.style.fontSize = '2rem'; el.innerText = 'CRIT ' + el.innerText; }
            el.style.left = e.clientX + 'px';
            el.style.top = e.clientY + 'px';
            document.body.appendChild(el);
            setTimeout(()=>el.remove(), 1000);

            updateUI();
            saveData();
        });

        // --- СОХРАНЕНИЕ ---
        let timer;
        function saveData() {
            clearTimeout(timer);
            timer = setTimeout(async ()=>{
                await supabase.from('users').update({score: user.score}).eq('telegram_id', user.id);
            }, 1500);
        }

        // --- КОЛЛЕКЦИЯ ---
        function renderCollection() {
            const grid = document.getElementById('col-grid');
            grid.innerHTML = '';
            ranks.forEach(r => {
                const div = document.createElement('div');
                div.className = 'grid-item';
                
                // Простая логика открытия
                let unlocked = false;
                if(r.min >= 0 && user.score >= r.min) unlocked = true;
                else if(r.min < 0 && user.score <= r.min) unlocked = true;
                else if(r.min === -1000) unlocked = true;

                if(unlocked) {
                    div.innerHTML = `<img src="assets/${r.img}"><span>${r.name}</span>`;
                } else {
                    div.classList.add('locked');
                    div.innerHTML = `<img src="assets/${r.img}">`;
                }
                grid.appendChild(div);
            });
        }

        // --- ЛИДЕРБОРД ---
        async function loadLeaderboard(type) {
            const list = document.getElementById('lb-list');
            list.innerHTML = 'Загрузка...';
            let q = supabase.from('users').select('username, score').limit(20);
            if(type==='top') q = q.order('score', {ascending: false});
            else q = q.order('score', {ascending: true});
            
            const {data} = await q;
            if(data) {
                list.innerHTML = '';
                data.forEach((u,i)=>{
                    const d = document.createElement('div');
                    d.className = 'list-item';
                    d.innerHTML = `<span>#${i+1} ${u.username}</span><span>${u.score.toLocaleString()}</span>`;
                    list.appendChild(d);
                });
            }
        }

        // --- START ---
        async function init() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                user.id = tg.initDataUnsafe.user.id;
                user.username = tg.initDataUnsafe.user.username || 'User';
            } else {
                user.id = localStorage.getItem('aid') || Math.floor(Math.random()*1e9);
                localStorage.setItem('aid', user.id);
                user.username = 'BrowserUser';
            }

            const { data } = await supabase.from('users').select('*').eq('telegram_id', user.id).single();
            if(data) {
                user.score = data.score;
            } else {
                await supabase.from('users').insert([{ telegram_id: user.id, username: user.username, score: 0 }]);
            }
            updateUI();
        }

        init();
    </script>
</body>
</html>